**WinBtrfs v1.9**
-------------

WinBtrfs — это драйвер Windows для файловой системы Linux нового поколения Btrfs. Это повторная реализация с нуля, она не содержит кода ядра Linux и должна работать в любой версии, начиная с Windows XP. Он также включен в состав бесплатной операционной системы [ReactOS](https://www.reactos.org/).

Если ваша файловая система Btrfs находится на программном RAID-устройстве MD, созданном Linux, вам также понадобится [WinMD](https://github.com/maharmstone/winmd) чтобы она отображалась в Windows.
under Windows.

Функции
--------

* Чтение и запись файловых систем Btrfs.
*Базовый RAID: RAID0, RAID1 и RAID10.
*Расширенный RAID: RAID5 и RAID6.
*Кэширование
*Обнаружение разделов Btrfs, даже если Windows обычно их игнорирует.
*Получение и настройка списков контроля доступа (ACL) с использованием xattr security.NTACL.
*Альтернативные потоки данных (например: Zone.Identifier хранится как xattr user.Zone.Identifier)
*Сопоставления пользователей Linux с пользователями Windows (см. ниже)
*Символические ссылки и другие точки повторной обработки
*Расширение оболочки для идентификации и создания подтомов, включая снимки
*Жесткие ссылки
*Разреженные файлы
*Кэш свободного пространства
*Предварительное выделение
*Асинхронное чтение и запись
*Тома Btrfs без разделов
*Параметры монтирования реестра для каждого тома (см. ниже)
*сжатие zlib
*LZO-сжатие
*Поддержка LXSS («Ubuntu для Windows»).
*Балансировка (включая возобновление балансов, запущенных в Linux)
*Добавление и удаление устройств
*Создание новых файловых систем с mkbtrfs.exeиubtrfs.dll
*Чистка
*ОБРЕЗАТЬ/ОТБРАТЬ
*Копия рефссылки
*Subvol отправлять и получать
*Деградированные крепления
*Дерево свободного пространства (флаг compat_ro free_space_cache)
*Сокращение и расширение
*Передача разрешений и т. д. для LXSS
*ZSTD-сжатие
*Флаг каталога Windows 10 с учетом регистра
*Оплокы
*Флаг несовместимости UUID метаданных (Linux 5.0)
*Трех- и четырехдисковый RAID1 (Linux 5.5)
*Новые типы контрольных сумм (xxhash, sha256, blake2) (Linux 5.5)
*Дерево групп блоков (Linux 6.1)

поддержка
----

* Full fs-verity support (Linux 5.15)
*Полная поддержка fs-verity (Linux 5.15)
*Зональная поддержка (Linux 5.11) (HM-SMR не поддерживается в Windows?)
*Дефрагментация
*Поддержка квот Btrfs
*Полная поддержка журнала транзакций
*Поддержка транзакций Windows (TxF)

Установка
------------

Чтобы установить драйвер, [загрузите и извлеките последнюю версию](https://github.com/maharmstone/btrfs/releases),
щелкните правой кнопкой мыши файл btrfs.inf и выберите «Установить». Драйвер подписан, поэтому должен работать «из коробки» в современных версиях Windows.

Если вы используете Windows 10 и у вас включена безопасная загрузка, вам, возможно, придется внести изменения в реестр, чтобы драйвер загрузился — [ниже](#secureboot).

WinBtrfs также доступен в следующих менеджерах пакетов:

* [Chocolatey](https://chocolatey.org/packages/winbtrfs)
```
choco install winbtrfs
```
* [Scoop](https://scoop.sh/#/apps?q=%22winbtrfs-np%22&s=0&d=1&o=true)
```
scoop bucket add nonportable
scoop install winbtrfs-np -g
```

Удаление
------------

Если вы хотите удалить, из командной строки запустите:

```
RUNDLL32.EXE SETUPAPI.DLL,InstallHinfSection DefaultUninstall 132 btrfs.inf
```

Возможно, вам придется указать полный путь к btrfs.inf.

Вы также можете зайти в диспетчер устройств, найти «Контроллер Btrfs» в разделе «Тома хранилища», щелкнуть правой кнопкой мыши и выбрать «Удалить». Установите флажок, чтобы удалить драйвер, и дайте Windows перезагрузиться.

Если вам нужно удалить систему через реестр, откройте regedit и установите для параметра HKLM\SYSTEM\CurrentControlSet\services\btrfs\Start значение 4, чтобы отключить службу. После перезагрузки вы можете удалить ключ btrfs и удалить C:\Windows\System32\drivers\btrfs.sys.

Сборка
-----------

Чтобы скомпилировать Visual C++ 2019, откройте каталог и позвольте CMake сделать свое дело. Если у вас правильно установлен Windows DDK, он должен работать.

Для компиляции с помощью GCC в Linux вам понадобится настроенный кросс-компилятор для любого i686-w64-mingw32из x86_64-w64-mingw32. Создайте каталог сборки, а затем используйте файлы набора инструментов CMake mingw-x86.cmakeили mingw-amd64.cmakeкак файлы для создания файла Makefile.

Сопоставления
--------

Сопоставления пользователей хранятся в разделе реестра HKLM\SYSTEM\CurrentControlSet\services\btrfs\Mappings. Создайте DWORD с именем вашего SID Windows (например, S-1-5-21-1379886684-2432464051-424789967-1001) и значением вашего uid Linux (например, 1000). Это вступит в силу при следующей загрузке драйвера.

Вы можете узнать свой текущий SID, запустив wmic useraccount get name,sid.

Аналогично, сопоставления групп хранятся в разделе GroupMappings. Запись по умолчанию сопоставляет группу «Пользователи Windows» с номером gid 100, который обычно означает «пользователи» в Linux. Вы также можете указать здесь SID пользователя, чтобы файлы, созданные пользователем, принадлежали определенной группе. Флаг setgid работает так же, как и в Linux.

LXSS («Ubuntu для Windows» / «Подсистема Windows для Linux»)
----------------------------------------------------------

Драйвер передаст метаданные Linux в последние версии LXSS, но вам придется сообщить Windows, что вы хотите это сделать. В командной строке Bash в Windows отредактируйте /etc/wsl.confтак, чтобы это выглядело следующим образом:

```
[automount]
enabled = true
options = "metadata"
mountFsTab = false
```

Оно вступит в силу при следующей перезагрузке. Да, если хотите, у вас должна быть возможность выполнить chroot для реальной установки Linux.

Команды
--------

Файл DLL shellbtrfs.dll предоставляет графический интерфейс, но его также можно использовать с rundll32.exe для выполнения некоторых задач из командной строки, что может быть полезно, если вы хотите запланировать периодический запуск чего-либо.

Имейте в виду, что rundll32 не предоставляет механизма возврата каких-либо кодов ошибок, поэтому любая из этих команд может завершиться автоматически.

* `rundll32.exe shellbtrfs.dll,CreateSubvol <path>`

* `rundll32.exe shellbtrfs.dll,CreateSnapshot <source> <destination>`

* `rundll32.exe shellbtrfs.dll,ReflinkCopy <source> <destination>`
This also accepts wildcards, and any number of source files.

Следующие команды требуют различных привилегий, поэтому для работы их необходимо запускать от имени администратора:

* `rundll32.exe shellbtrfs.dll,SendSubvol <source> [-p <parent>] [-c <clone subvol>] <stream file>`
 Флаги -p и -c такие же, как btrfs sendв Linux. Вы можете указать любое количество подтомов клонов

* `rundll32.exe shellbtrfs.dll,RecvSubvol <stream file> <destination>`

* `rundll32.exe shellbtrfs.dll,StartScrub <drive>`

* `rundll32.exe shellbtrfs.dll,StopScrub <drive>`

Поиск неисправностей
---------------

* Как мне это отладить?

На странице выпусков можно загрузить zip-файлы, содержащие PDB. Или вы можете попробовать сервер символов http://symbols.burntcomma.com/ — в Windbg установите путь к символу примерно так:
symbol path to something like this:

```symsrv*symsrv.dll*C:\symbols*http://msdl.microsoft.com/download/symbols;symsrv*symsrv.dll*C:\symbols*http://symbols.burntcomma.com```

* Имена файлов странные! 

* Я получаю странные ошибки в определенных файлах или каталогах!

Драйвер предполагает, что все имена файлов имеют кодировку UTF-8. В настоящее время это должно быть значением по умолчанию для большинства настроек — если вы не используете UTF-8, возможно, стоит заняться преобразованием ваших файлов.

* <a name="secureboot"></a>Как мне заставить это работать с включенной безопасной загрузкой?

Для самых последних версий Windows 10 Microsoft ввела более обременительные требования к подписи, которые, по-видимому, недоступны для драйверов с открытым исходным кодом.

Чтобы обойти эту проблему, перейдите HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\CI\Policyв Regedit, создайте новое значение DWORD с именем UpgradedSystemи установите его на 1 и перезагрузитесь.

Или вы всегда можете просто отключить безопасную загрузку в настройках BIOS.

* Корень диска не чувствителен к регистру в LXSS.

Это то, что Microsoft жестко запрограммировала в LXSS, предположительно, чтобы люди не засоряли свои системы, запуская mkdir /mnt/c/WiNdOwS.

* Как изменить букву диска?

Установив расширение оболочки, щелкните правой кнопкой мыши диск в проводнике, выберите «Свойства» и перейдите на вкладку Btrfs. Должна быть кнопка, позволяющая изменить букву диска.

* У меня все еще проблемы с буквами дисков

В Regedit попробуйте удалить соответствующие записи HKEY_LOCAL_MACHINE\SYSTEM\MountedDevices, а затем перезагрузиться.

* Как отформатировать раздел как Btrfs?

Используйте включенную программу командной строки mkbtrfs.exe. К сожалению, мы не можем добавить Btrfs в собственное диалоговое окно Windows, поскольку список файловых систем жестко запрограммирован. Вы также можете запустить format /fs:btrfs, если вам не нужно устанавливать какие-либо параметры, специфичные для Btrfs.

* Я не могу переформатировать смонтированную файловую систему Btrfs.

Если диалоговое окно «Формат» Windows не появляется, попробуйте запустить format.com с флагом /fs, например format /fs:ntfs D:.

* Я не могу подключить Synology NAS

Synology, похоже, использует LVM для своих блочных устройств. Пока кто-нибудь не напишет драйвер LVM для Windows, вам не повезло.

* Я не могу подключить Thecus NAS

тhecus использует Linux MD RAID для своих блочных устройств. Вам также необходимо будет установить[WinMD](https://github.com/maharmstone/winmd)


* 64-битная Windows 7 не загружает драйвер

Убедитесь, что у вас установлен [KB3033929](https://www.microsoft.com/en-gb/download/details.aspx?id=46148) Или рассмотрите возможность установки с «депонированного» ISO, который включает все обновления.

* Диск не отображается, и установлено программное обеспечение Paragon

Известно, что программное обеспечение для чтения файловой системы Paragon отключает автомонтирование. Отключите или удалите Paragon, затем снова включите автомонтирование, запустив diskpartи набрав automount enable.

* Диск не отображается в очень старых версиях Windows

В очень старых версиях Windows (XP, Server 2003?) Windows полностью игнорирует разделы Linux. Если это ваш случай, попробуйте запустить fdiskLinux и изменить тип раздела с 83 на 7.

